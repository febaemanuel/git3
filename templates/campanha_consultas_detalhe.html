{% extends "base.html" %}

{% block title %}{{ campanha.nome }}{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border: none;
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
        font-size: 2rem;
        font-weight: 700;
    }

    .btn-whatsapp {
        background: #25d366;
        border-color: #25d366;
        color: white;
    }

    .btn-whatsapp:hover {
        background: #128c7e;
        border-color: #128c7e;
        color: white;
    }

    .quick-action-btn {
        padding: 4px 8px;
        font-size: 12px;
    }

    .table-actions .btn {
        padding: 2px 6px;
    }

    .filter-badge {
        font-size: 10px;
        vertical-align: middle;
        margin-left: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Cabecalho -->
    <div class="col-12 mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('consultas_dashboard') }}">Dashboard</a></li>
                <li class="breadcrumb-item active">{{ campanha.nome }}</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h2>{{ campanha.nome }}</h2>
                {% if campanha.descricao %}
                <p class="text-muted mb-0">{{ campanha.descricao }}</p>
                {% endif %}
            </div>
            <div class="d-flex gap-2 flex-wrap">
                {% if campanha.status in ['pendente', 'pronta', 'pausado'] %}
                <form method="POST" action="{{ url_for('consultas_campanha_iniciar', id=campanha.id) }}"
                    class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-whatsapp">
                        <i class="bi bi-play-fill"></i> Iniciar Envio
                    </button>
                </form>
                {% elif campanha.status == 'enviando' %}
                <form method="POST" action="{{ url_for('consultas_campanha_pausar', id=campanha.id) }}"
                    class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-pause-fill"></i> Pausar
                    </button>
                </form>
                {% endif %}

                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEnvioRapido">
                    <i class="bi bi-lightning-fill"></i> Envio Rapido
                </button>

                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-gear"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal"
                                data-bs-target="#modalEditarCampanha">
                                <i class="bi bi-pencil"></i> Editar Campanha
                            </a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="excluirCampanha()">
                                <i class="bi bi-trash"></i> Excluir Campanha
                            </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Estatisticas -->
    <div class="col-12 mb-4">
        <div class="row g-3">
            <div class="col">
                <div class="card stat-card bg-light">
                    <div class="card-body text-center py-3">
                        <h3 class="mb-0">{{ campanha.total_consultas }}</h3>
                        <small class="text-muted">Total</small>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card" style="background: #e3f2fd;">
                    <div class="card-body text-center py-3">
                        <h3 class="text-info mb-0">{{ campanha.total_enviados }}</h3>
                        <small class="text-muted">Enviados</small>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card" style="background: #e8f5e9;">
                    <div class="card-body text-center py-3">
                        <h3 class="text-success mb-0">{{ campanha.total_confirmados }}</h3>
                        <small class="text-muted">Confirmados</small>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card" style="background: #fff3e0;">
                    <div class="card-body text-center py-3">
                        <h3 class="text-warning mb-0">{{ campanha.total_aguardando_comprovante or 0 }}</h3>
                        <small class="text-muted">Ag. Comprovante</small>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card stat-card" style="background: #ffebee;">
                    <div class="card-body text-center py-3">
                        <h3 class="text-danger mb-0">{{ campanha.total_rejeitados }}</h3>
                        <small class="text-muted">Rejeitados</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informacoes de Agendamento -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-calendar-check"></i> Agendamento e Controle</span>
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                    data-bs-target="#modalEditarCampanha">
                    <i class="bi bi-pencil"></i> Editar
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <small class="text-muted">Meta Diaria</small>
                        <h5>{{ campanha.meta_diaria or 50 }} pessoas/dia</h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Enviados Hoje</small>
                        <h5>
                            <span id="enviados-hoje">{{ campanha.enviados_hoje or 0 }}</span> / {{ campanha.meta_diaria
                            or 50 }}
                        </h5>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar bg-info"
                                style="width: {{ ((campanha.enviados_hoje or 0) / (campanha.meta_diaria or 50) * 100)|int }}%">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Horario de Funcionamento</small>
                        <h5>{{ '%02d' % (campanha.hora_inicio or 8) }}:00 - {{ '%02d' % (campanha.hora_fim or 18) }}:00
                        </h5>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Status</small>
                        <h5>
                            <span
                                class="badge bg-{% if campanha.status == 'enviando' %}primary{% elif campanha.status == 'concluido' %}success{% elif campanha.status == 'erro' %}danger{% else %}secondary{% endif %}">
                                {{ campanha.status.replace('_', ' ').title() }}
                            </span>
                        </h5>
                    </div>
                </div>
                {% if campanha.status_msg %}
                <div class="alert alert-info mt-3 mb-0">
                    <i class="bi bi-info-circle"></i> {{ campanha.status_msg }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Barra de Progresso -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Progresso do Envio</span>
                    <span id="progresso-texto">{{ (campanha.total_enviados / campanha.total_consultas * 100)|round(1) if
                        campanha.total_consultas > 0 else 0 }}%</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" role="progressbar"
                        style="width: {{ (campanha.total_confirmados / campanha.total_consultas * 100)|round(1) if campanha.total_consultas > 0 else 0 }}%"
                        title="Confirmados">
                    </div>
                    <div class="progress-bar bg-warning" role="progressbar"
                        style="width: {{ ((campanha.total_aguardando_comprovante or 0) / campanha.total_consultas * 100)|round(1) if campanha.total_consultas > 0 else 0 }}%"
                        title="Ag. Comprovante">
                    </div>
                    <div class="progress-bar bg-danger" role="progressbar"
                        style="width: {{ (campanha.total_rejeitados / campanha.total_consultas * 100)|round(1) if campanha.total_consultas > 0 else 0 }}%"
                        title="Rejeitados">
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small>
                        <span class="badge bg-success">Confirmados</span>
                        <span class="badge bg-warning">Ag. Comprovante</span>
                        <span class="badge bg-danger">Rejeitados</span>
                    </small>
                    <small class="text-muted">
                        Taxa de confirmacao: <strong>{{ (campanha.total_confirmados / campanha.total_enviados *
                            100)|round(1) if campanha.total_enviados > 0 else 0 }}%</strong>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Consultas -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <span><i class="bi bi-calendar2-check"></i> Consultas ({{ consultas|length }})</span>

                    <!-- Filtros -->
                    <div class="btn-group btn-group-sm flex-wrap">
                        <a href="{{ url_for('consultas_campanha_detalhe', id=campanha.id, filtro='todos') }}"
                            class="btn {% if filtro == 'todos' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                            Todos
                        </a>
                        <a href="{{ url_for('consultas_campanha_detalhe', id=campanha.id, filtro='aguardando_envio') }}"
                            class="btn {% if filtro == 'aguardando_envio' %}btn-secondary{% else %}btn-outline-secondary{% endif %}">
                            Pendentes
                        </a>
                        <a href="{{ url_for('consultas_campanha_detalhe', id=campanha.id, filtro='aguardando_confirmacao') }}"
                            class="btn {% if filtro == 'aguardando_confirmacao' %}btn-info{% else %}btn-outline-info{% endif %}">
                            Ag. Confirmacao
                        </a>
                        <a href="{{ url_for('consultas_campanha_detalhe', id=campanha.id, filtro='aguardando_comprovante') }}"
                            class="btn {% if filtro == 'aguardando_comprovante' %}btn-warning{% else %}btn-outline-warning{% endif %}">
                            Ag. Comprovante
                        </a>
                        <a href="{{ url_for('consultas_campanha_detalhe', id=campanha.id, filtro='confirmados') }}"
                            class="btn {% if filtro == 'confirmados' %}btn-success{% else %}btn-outline-success{% endif %}">
                            Confirmados
                        </a>
                        <a href="{{ url_for('consultas_campanha_detalhe', id=campanha.id, filtro='cancelados') }}"
                            class="btn {% if filtro == 'cancelados' %}btn-dark{% else %}btn-outline-dark{% endif %}">
                            Cancelados
                        </a>
                        <a href="{{ url_for('consultas_campanha_detalhe', id=campanha.id, filtro='rejeitados') }}"
                            class="btn {% if filtro == 'rejeitados' %}btn-danger{% else %}btn-outline-danger{% endif %}">
                            Rejeitados
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                {% if consultas %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Paciente</th>
                                <th>Telefone</th>
                                <th>Especialidade</th>
                                <th>Data Consulta</th>
                                <th class="text-center">Status</th>
                                <th>Data Envio</th>
                                <th class="text-center" style="min-width: 200px;">Acoes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for consulta in consultas %}
                            <tr>
                                <td>
                                    <strong>{{ consulta.paciente }}</strong>
                                    {% if consulta.motivo_rejeicao %}
                                    <br><small class="text-danger"><i class="bi bi-exclamation-circle"></i> {{
                                        consulta.motivo_rejeicao[:40] }}...</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ consulta.telefone_cadastro or '-' }}</small>
                                    {% if consulta.telefone_registro and consulta.telefone_registro !=
                                    consulta.telefone_cadastro %}
                                    <br><small class="text-muted">{{ consulta.telefone_registro }}</small>
                                    {% endif %}
                                </td>
                                <td><small>{{ consulta.especialidade or consulta.tipo or '-' }}</small></td>
                                <td><small>{{ consulta.data_aghu or '-' }}</small></td>
                                <td class="text-center">
                                    {% if consulta.status == 'CONFIRMADO' %}
                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Confirmado</span>
                                    {% elif consulta.status == 'AGUARDANDO_COMPROVANTE' %}
                                    <span class="badge bg-warning text-dark"><i class="bi bi-file-earmark"></i> Ag.
                                        Comprovante</span>
                                    {% elif consulta.status == 'AGUARDANDO_CONFIRMACAO' %}
                                    <span class="badge bg-info"><i class="bi bi-hourglass-split"></i> Ag.
                                        Confirmacao</span>
                                    {% elif consulta.status == 'CANCELADO' %}
                                    <span class="badge bg-dark"><i class="bi bi-x-octagon"></i> Cancelado</span>
                                    {% elif consulta.status == 'REJEITADO' %}
                                    <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Rejeitado</span>
                                    {% elif consulta.status == 'AGUARDANDO_ENVIO' %}
                                    <span class="badge bg-secondary"><i class="bi bi-clock"></i> Pendente</span>
                                    {% elif consulta.status == 'AGUARDANDO_REAGENDAMENTO' %}
                                    <span class="badge bg-warning text-dark"><i class="bi bi-calendar-event"></i>
                                        Reagendar</span>
                                    {% elif consulta.status == 'REAGENDADO' %}
                                    <span class="badge bg-primary"><i class="bi bi-calendar-check"></i>
                                        Reagendado</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ consulta.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if consulta.data_envio_mensagem %}
                                    <small>{{ consulta.data_envio_mensagem.strftime('%d/%m %H:%M') }}</small>
                                    {% else %}
                                    <small class="text-muted">-</small>
                                    {% endif %}
                                </td>
                                <td class="text-center table-actions">
                                    <div class="d-flex justify-content-center gap-1 flex-wrap">
                                        <!-- Ver Detalhes/Chat -->
                                        <a href="{{ url_for('consulta_detalhe', id=consulta.id) }}"
                                            class="btn btn-sm btn-outline-primary" title="Ver detalhes e chat">
                                            <i class="bi bi-chat-dots"></i>
                                        </a>

                                        {% if consulta.status == 'AGUARDANDO_COMPROVANTE' %}
                                        <!-- Enviar Comprovante Rapido -->
                                        <button class="btn btn-sm btn-warning" title="Enviar comprovante"
                                            onclick="abrirEnvioComprovante({{ consulta.id }}, '{{ consulta.paciente }}')">
                                            <i class="bi bi-file-earmark-arrow-up"></i>
                                        </button>
                                        {% endif %}

                                        {% if consulta.status == 'AGUARDANDO_CONFIRMACAO' %}
                                        <!-- Confirmar Manualmente -->
                                        <button class="btn btn-sm btn-outline-success" title="Confirmar manualmente"
                                            onclick="confirmarConsulta({{ consulta.id }})">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        {% endif %}

                                        {% if consulta.status == 'AGUARDANDO_REAGENDAMENTO' or consulta.status ==
                                        'AGUARDANDO_OPCAO_REJEICAO' %}
                                        <!-- Reagendar -->
                                        <button class="btn btn-sm btn-primary" title="Reagendar consulta"
                                            onclick="abrirReagendamento({{ consulta.id }}, '{{ consulta.paciente }}')">
                                            <i class="bi bi-calendar-range"></i>
                                        </button>
                                        {% endif %}

                                        {% if consulta.status not in ['CONFIRMADO', 'REJEITADO'] %}
                                        <!-- Reenviar Mensagem -->
                                        <button class="btn btn-sm btn-outline-info" title="Reenviar mensagem"
                                            onclick="reenviarMensagem({{ consulta.id }})">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </button>

                                        <!-- Cancelar -->
                                        <button class="btn btn-sm btn-outline-danger" title="Cancelar/Rejeitar"
                                            onclick="cancelarConsulta({{ consulta.id }})">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                        {% endif %}

                                        <!-- Excluir -->
                                        <button class="btn btn-sm btn-danger" title="Excluir consulta"
                                            onclick="excluirConsulta({{ consulta.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox text-muted" style="font-size: 48px;"></i>
                    <p class="text-muted mt-3">Nenhuma consulta encontrada</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Envio Rapido de Comprovante -->
<div class="modal fade" id="modalComprovante" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-file-earmark-arrow-up"></i> Enviar Comprovante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Paciente:</strong> <span id="comprovanteNomePaciente"></span></p>
                <form id="formComprovanteRapido" enctype="multipart/form-data">
                    <input type="hidden" id="comprovanteConsultaId">
                    <div class="mb-3">
                        <label class="form-label">Selecione o Comprovante (PDF/JPG/PNG)</label>
                        <input type="file" class="form-control" id="inputComprovanteRapido"
                            accept=".pdf,.jpg,.jpeg,.png" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnEnviarComprovanteRapido"
                    onclick="enviarComprovanteRapido()">
                    <i class="bi bi-send"></i> Enviar Comprovante
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Campanha -->
<div class="modal fade" id="modalEditarCampanha" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Campanha</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarCampanha">
                    <div class="mb-3">
                        <label class="form-label">Nome da Campanha</label>
                        <input type="text" class="form-control" id="editNome" value="{{ campanha.nome }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descricao</label>
                        <textarea class="form-control" id="editDescricao">{{ campanha.descricao or '' }}</textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Meta Diaria</label>
                            <input type="number" class="form-control" id="editMetaDiaria"
                                value="{{ campanha.meta_diaria or 50 }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Intervalo (segundos)</label>
                            <input type="number" class="form-control" id="editIntervalo"
                                value="{{ campanha.tempo_entre_envios or 15 }}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Hora Inicio</label>
                            <input type="number" class="form-control" id="editHoraInicio"
                                value="{{ campanha.hora_inicio or 8 }}" min="0" max="23">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Hora Fim</label>
                            <input type="number" class="form-control" id="editHoraFim"
                                value="{{ campanha.hora_fim or 18 }}" min="0" max="23">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarCampanha()">
                    <i class="bi bi-check"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Envio Rapido em Lote -->
<div class="modal fade" id="modalEnvioRapido" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-lightning-fill"></i> Envio Rapido de Comprovantes</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Selecione os pacientes e envie comprovantes de forma rapida.</p>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>{{ campanha.total_aguardando_comprovante or 0 }}</strong> consultas aguardando comprovante
                </div>

                <div class="list-group" id="listaAguardandoComprovante">
                    {% for consulta in consultas %}
                    {% if consulta.status == 'AGUARDANDO_COMPROVANTE' %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ consulta.paciente }}</strong>
                            <br><small class="text-muted">{{ consulta.especialidade }} - {{ consulta.data_aghu
                                }}</small>
                        </div>
                        <button class="btn btn-sm btn-warning"
                            onclick="abrirEnvioComprovante({{ consulta.id }}, '{{ consulta.paciente }}')">
                            <i class="bi bi-file-earmark-arrow-up"></i> Enviar
                        </button>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Confirmar consulta manualmente
    function confirmarConsulta(consultaId) {
        if (!confirm('Confirmar esta consulta manualmente?')) return;

        fetch(`/api/consulta/${consultaId}/confirmar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
        })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert('Consulta confirmada!');
                    location.reload();
                } else {
                    alert('Erro: ' + (data.erro || 'Desconhecido'));
                }
            })
            .catch(err => alert('Erro ao confirmar'));
    }

    // Cancelar/Rejeitar consulta
    function cancelarConsulta(consultaId) {
        const motivo = prompt('Motivo do cancelamento:');
        if (!motivo) return;

        fetch(`/api/consulta/${consultaId}/cancelar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ motivo: motivo })
        })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert('Consulta cancelada!');
                    location.reload();
                } else {
                    alert('Erro: ' + (data.erro || 'Desconhecido'));
                }
            })
            .catch(err => alert('Erro ao cancelar'));
    }

    // Abrir modal de comprovante
    function abrirEnvioComprovante(consultaId, paciente) {
        document.getElementById('comprovanteConsultaId').value = consultaId;
        document.getElementById('comprovanteNomePaciente').textContent = paciente;
        document.getElementById('inputComprovanteRapido').value = '';

        // Fechar modal de envio rapido se estiver aberto
        const modalEnvioRapido = bootstrap.Modal.getInstance(document.getElementById('modalEnvioRapido'));
        if (modalEnvioRapido) modalEnvioRapido.hide();

        new bootstrap.Modal(document.getElementById('modalComprovante')).show();
    }

    // Enviar comprovante rapido
    let enviandoComprovante = false;
    function enviarComprovanteRapido() {
        if (enviandoComprovante) {
            alert('Aguarde...');
            return;
        }

        const consultaId = document.getElementById('comprovanteConsultaId').value;
        const file = document.getElementById('inputComprovanteRapido').files[0];

        if (!file) {
            alert('Selecione um arquivo');
            return;
        }

        enviandoComprovante = true;
        const btn = document.getElementById('btnEnviarComprovanteRapido');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

        const formData = new FormData();
        formData.append('comprovante', file);

        fetch(`/api/consulta/${consultaId}/enviar_comprovante`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token() }}' },
            body: formData
        })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert('Comprovante enviado com sucesso!');
                    location.reload();
                } else {
                    alert('Erro: ' + data.erro);
                    enviandoComprovante = false;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-send"></i> Enviar Comprovante';
                }
            })
            .catch(err => {
                alert('Erro: ' + err);
                enviandoComprovante = false;
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send"></i> Enviar Comprovante';
            });
    }

    // Editar consulta
    function editarConsulta(consultaId) {
        alert('Funcionalidade em desenvolvimento. Use a pagina de detalhes por enquanto.');
    }

    // Reenviar mensagem
    let reenviando = {};
    function reenviarMensagem(consultaId) {
        if (reenviando[consultaId]) {
            alert('Aguarde, mensagem sendo reenviada...');
            return;
        }

        if (!confirm('Reenviar mensagem de confirmacao para este paciente?')) return;

        reenviando[consultaId] = true;

        fetch(`/api/consulta/${consultaId}/reenviar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
        })
            .then(r => r.json())
            .then(data => {
                reenviando[consultaId] = false;
                if (data.sucesso) {
                    alert('Mensagem reenviada!');
                    location.reload();
                } else {
                    alert('Erro: ' + (data.erro || 'Desconhecido'));
                }
            })
            .catch(err => {
                reenviando[consultaId] = false;
                alert('Erro: ' + err);
            });
    }

    // Excluir consulta
    function excluirConsulta(consultaId) {
        if (!confirm('Tem certeza que deseja EXCLUIR esta consulta? Esta acao nao pode ser desfeita.')) return;

        fetch(`/api/consulta/${consultaId}/excluir`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
        })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert('Consulta excluida!');
                    location.reload();
                } else {
                    alert('Erro: ' + (data.erro || 'Desconhecido'));
                }
            })
            .catch(err => alert('Erro: ' + err));
    }

    // Salvar campanha
    function salvarCampanha() {
        const dados = {
            nome: document.getElementById('editNome').value,
            descricao: document.getElementById('editDescricao').value,
            meta_diaria: parseInt(document.getElementById('editMetaDiaria').value),
            tempo_entre_envios: parseInt(document.getElementById('editIntervalo').value),
            hora_inicio: parseInt(document.getElementById('editHoraInicio').value),
            hora_fim: parseInt(document.getElementById('editHoraFim').value)
        };

        fetch('/api/consultas/campanha/{{ campanha.id }}/editar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify(dados)
        })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert('Campanha atualizada!');
                    location.reload();
                } else {
                    alert('Erro: ' + (data.erro || 'Desconhecido'));
                }
            })
            .catch(err => alert('Erro: ' + err));
    }

    // Excluir campanha
    function excluirCampanha() {
        if (!confirm('Tem certeza que deseja EXCLUIR esta campanha e todas as consultas? Esta acao nao pode ser desfeita.')) return;

        fetch('/api/consultas/campanha/{{ campanha.id }}/excluir', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
        })
            .then(r => r.json())
            .then(data => {
                if (data.sucesso) {
                    alert('Campanha excluida!');
                    window.location.href = '{{ url_for("consultas_dashboard") }}';
                } else {
                    alert('Erro: ' + (data.erro || 'Desconhecido'));
                }
            })
            .catch(err => alert('Erro: ' + err));
    }
</script>

{% include 'campanha_consultas_modal_reagendar.html' %}
{% endblock %}