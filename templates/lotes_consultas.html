{% extends "base.html" %}

{% block title %}Gerenciar Lotes de Consultas{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-stack"></i> Gerenciar Lotes de Consultas</h2>
                <a href="{{ url_for('consultas_importar') }}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Novo Lote
                </a>
            </div>
        </div>
    </div>

    {% if lotes %}
    <div class="row">
        {% for item in lotes %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ item.lote.nome }}</h5>
                    <span class="badge bg-primary">{{ item.lote.tipo }}</span>
                </div>
                <div class="card-body">
                    <!-- Estatísticas -->
                    <div class="mb-3">
                        <div class="row text-center mb-2">
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <h4 class="mb-0 text-primary">{{ item.total }}</h4>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2">
                                    <h4 class="mb-0 text-info">{{ item.enviados }}</h4>
                                    <small class="text-muted">Enviados</small>
                                </div>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <h6 class="mb-0 text-warning">{{ item.aguardando_envio }}</h6>
                                    <small class="text-muted" style="font-size: 0.7rem;">Pendentes</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <h6 class="mb-0 text-success">{{ item.confirmados }}</h6>
                                    <small class="text-muted" style="font-size: 0.7rem;">Confirmados</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border rounded p-2">
                                    <h6 class="mb-0 text-secondary">{{ item.cancelados }}</h6>
                                    <small class="text-muted" style="font-size: 0.7rem;">Cancelados</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de progresso -->
                    <div class="mb-3">
                        <small class="text-muted">Progresso de envio</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar"
                                 style="width: {{ item.percentual_enviado }}%"
                                 aria-valuenow="{{ item.percentual_enviado }}"
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ "%.1f"|format(item.percentual_enviado) }}%
                            </div>
                        </div>
                    </div>

                    <!-- Configurações de envio -->
                    <div class="mb-3">
                        <small class="text-muted d-block"><i class="bi bi-gear"></i> Configurações:</small>
                        <small class="d-block">
                            <i class="bi bi-clock"></i> {{ item.lote.hora_inicio }}h - {{ item.lote.hora_fim }}h
                        </small>
                        <small class="d-block">
                            <i class="bi bi-speedometer2"></i> Meta: {{ item.lote.meta_diaria }}/dia
                        </small>
                        <small class="d-block">
                            <i class="bi bi-hourglass-split"></i> Intervalo: {{ item.lote.tempo_entre_envios }}s
                        </small>
                    </div>

                    <!-- Contador diário -->
                    {% if item.lote.enviados_hoje > 0 %}
                    <div class="alert alert-info py-2 mb-3">
                        <small>
                            <i class="bi bi-calendar-check"></i>
                            Hoje: {{ item.lote.enviados_hoje }}/{{ item.lote.meta_diaria }} enviados
                        </small>
                    </div>
                    {% endif %}

                    <!-- Data de criação -->
                    <small class="text-muted d-block mb-3">
                        <i class="bi bi-calendar"></i> Criado em {{ item.lote.created_at.strftime('%d/%m/%Y %H:%M') }}
                    </small>
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('lote_consultas_detalhe', id=item.lote.id) }}"
                       class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-gear"></i> Gerenciar Lote
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% else %}
    <!-- Sem lotes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                    <h4 class="mt-3 mb-2">Nenhum lote de consultas encontrado</h4>
                    <p class="text-muted mb-4">Comece importando uma planilha de consultas para criar seu primeiro lote.</p>
                    <a href="{{ url_for('consultas_importar') }}" class="btn btn-success">
                        <i class="bi bi-upload"></i> Importar Planilha
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
