{% extends "base.html" %}

{% block title %}Relatórios{% endblock %}

{% block content %}
<div class="row">
    <!-- Cabeçalho -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2><i class="bi bi-bar-chart-fill"></i> Relatórios</h2>
                <p class="text-muted mb-0">Visão geral de todas as campanhas</p>
            </div>
        </div>
    </div>

    <!-- Cards de Estatísticas Globais -->
    <div class="col-12 mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h2>{{ stats.total_contatos }}</h2>
                        <small>Total de Contatos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h2>{{ stats.total_enviados }}</h2>
                        <small>Enviados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h2>{{ stats.total_confirmados }}</h2>
                        <small>Confirmados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body text-center">
                        <h2>{{ stats.total_rejeitados }}</h2>
                        <small>Rejeitados</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards Secundários -->
    <div class="col-12 mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-secondary">{{ stats.total_pendentes }}</h3>
                        <small class="text-muted">Pendentes de Envio</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-info">{{ stats.total_aguardando }}</h3>
                        <small class="text-muted">Aguardando Resposta</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-danger">{{ stats.total_sem_whatsapp }}</h3>
                        <small class="text-muted">Sem WhatsApp</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-primary">{{ stats.total_campanhas }}</h3>
                        <small class="text-muted">Campanhas</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-pie-chart"></i> Status Geral dos Contatos
            </div>
            <div class="card-body">
                <canvas id="chartStatusGeral" height="250"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Progresso por Campanha
            </div>
            <div class="card-body">
                <canvas id="chartProgressoCampanhas" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Tabela de Campanhas -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-table"></i> Detalhes por Campanha
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Campanha</th>
                                <th class="text-center">Total</th>
                                <th class="text-center">Enviados</th>
                                <th class="text-center">Aguardando</th>
                                <th class="text-center">Confirmados</th>
                                <th class="text-center">Rejeitados</th>
                                <th class="text-center">Pendentes</th>
                                <th class="text-center">Sem ZAP</th>
                                <th class="text-center">Progresso</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for camp in campanhas %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('campanha_detalhe', id=camp.id) }}">
                                        <strong>{{ camp.nome }}</strong>
                                    </a>
                                    <br>
                                    <small class="text-muted">
                                        <span class="badge bg-{{ 'success' if camp.status == 'concluida' else 'warning' if camp.status == 'pausada' else 'info' if camp.status == 'em_andamento' else 'secondary' }}">
                                            {{ camp.status.replace('_', ' ').title() }}
                                        </span>
                                    </small>
                                </td>
                                <td class="text-center">{{ camp.total_contatos }}</td>
                                <td class="text-center text-info">{{ camp.total_enviados }}</td>
                                <td class="text-center text-primary">{{ camp.aguardando_resposta() }}</td>
                                <td class="text-center text-success">{{ camp.total_confirmados }}</td>
                                <td class="text-center text-warning">{{ camp.total_rejeitados }}</td>
                                <td class="text-center text-secondary">{{ camp.pendentes_enviar() }}</td>
                                <td class="text-center text-danger">{{ camp.sem_whatsapp() }}</td>
                                <td class="text-center" style="width: 150px;">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-success" style="width: {{ (camp.total_confirmados / camp.total_contatos * 100) if camp.total_contatos else 0 }}%"></div>
                                        <div class="progress-bar bg-warning" style="width: {{ (camp.total_rejeitados / camp.total_contatos * 100) if camp.total_contatos else 0 }}%"></div>
                                        <div class="progress-bar bg-info" style="width: {{ (camp.aguardando_resposta() / camp.total_contatos * 100) if camp.total_contatos else 0 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ camp.percentual_conclusao() }}%</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Dados
const statsGeral = {
    confirmados: {{ stats.total_confirmados }},
    rejeitados: {{ stats.total_rejeitados }},
    aguardando: {{ stats.total_aguardando }},
    pendentes: {{ stats.total_pendentes }},
    semWhatsapp: {{ stats.total_sem_whatsapp }}
};

const campanhas = [
    {% for camp in campanhas %}
    {
        nome: "{{ camp.nome[:20] }}",
        total: {{ camp.total_contatos }},
        enviados: {{ camp.total_enviados }},
        confirmados: {{ camp.total_confirmados }},
        rejeitados: {{ camp.total_rejeitados }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// Gráfico de Pizza - Status Geral
new Chart(document.getElementById('chartStatusGeral'), {
    type: 'doughnut',
    data: {
        labels: ['Confirmados', 'Rejeitados', 'Aguardando Resposta', 'Pendentes', 'Sem WhatsApp'],
        datasets: [{
            data: [
                statsGeral.confirmados,
                statsGeral.rejeitados,
                statsGeral.aguardando,
                statsGeral.pendentes,
                statsGeral.semWhatsapp
            ],
            backgroundColor: ['#198754', '#ffc107', '#0dcaf0', '#6c757d', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Gráfico de Barras - Progresso por Campanha
new Chart(document.getElementById('chartProgressoCampanhas'), {
    type: 'bar',
    data: {
        labels: campanhas.map(c => c.nome),
        datasets: [
            {
                label: 'Confirmados',
                data: campanhas.map(c => c.confirmados),
                backgroundColor: '#198754'
            },
            {
                label: 'Rejeitados',
                data: campanhas.map(c => c.rejeitados),
                backgroundColor: '#ffc107'
            },
            {
                label: 'Enviados',
                data: campanhas.map(c => c.enviados - c.confirmados - c.rejeitados),
                backgroundColor: '#0dcaf0'
            }
        ]
    },
    options: {
        responsive: true,
        scales: {
            x: { stacked: true },
            y: { stacked: true }
        },
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}
